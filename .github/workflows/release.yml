name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          CHANGELOG=$(./scripts/git-changelog.sh "$PREVIOUS_TAG")
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update version in package
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          DATE=$(date +%Y/%m/%d)
          sed -i "s|\[.*JSON Resume renderer|[$DATE v$VERSION JSON Resume renderer|" jsonresume.sty
          # Update version in documentation
          if [ -f jsonresume-doc.tex ]; then
            sed -i "s|\\\\def\\\\packageversion{.*}|\\\\def\\\\packageversion{$VERSION}|" jsonresume-doc.tex
            sed -i "s|\\\\def\\\\packagedate{.*}|\\\\def\\\\packagedate{$DATE}|" jsonresume-doc.tex
          fi

      - name: Install TeX Live
        uses: zauguin/install-texlive@v4
        with:
          packages: >
            scheme-basic
            luatex
            luaotfload
            fontspec
            enumitem
            l3kernel
            l3packages
            hyperref
            geometry
            lm
            etoolbox
            iftex
            kvsetkeys
            kvdefinekeys
            kvoptions
            ltxcmds
            infwarerr
            intcalc
            bigintcalc
            bitset
            atbegshi
            atveryend
            rerunfilecheck
            uniquecounter
            refcount
            hycolor
            letltxmacro
            auxhook
            pdfescape
            stringenc
            pdftexcmds
            url
            xcolor
            listings
            tools
            booktabs
            parskip
            fancyvrb
            microtype

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y curl zip

      - name: Build documentation PDF
        run: |
          lualatex --interaction=nonstopmode jsonresume-doc.tex || true
          lualatex --interaction=nonstopmode jsonresume-doc.tex || true

      - name: Build example PDF
        run: |
          cd example
          lualatex --shell-escape --interaction=nonstopmode jsonresume-example.tex || true
          lualatex --shell-escape --interaction=nonstopmode jsonresume-example.tex || true

      - name: Run tests
        run: |
          cd tests
          chmod +x run-tests.sh
          ./run-tests.sh --skip-network

      - name: Create CTAN package
        run: |
          chmod +x scripts/build-ctan.sh
          ./scripts/build-ctan.sh ${{ steps.get_version.outputs.VERSION }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/jsonresume.zip
            dist/jsonresume-ctan.zip
            jsonresume-doc.pdf
            example/jsonresume-example.pdf
          body: |
            ## JSON Resume LaTeX Package v${{ steps.get_version.outputs.VERSION }}
          
            A LuaLaTeX package for rendering JSON Resume data into professional resumes.
            
            ### What's New
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### Downloads
            - `jsonresume.zip` - Package files for manual installation
            - `jsonresume-ctan.zip` - CTAN submission package
            - `jsonresume-doc.pdf` - Package documentation
            - `jsonresume-example.pdf` - Example output
            
            ### Installation
            
            **From CTAN/TeX Live:** The package is available on CTAN at https://ctan.org/pkg/jsonresume
            
            **Manual:** Extract `jsonresume.zip` to your project directory or to `~/texmf/tex/latex/jsonresume/`
            
            ### Quick Start
            ```latex
            \documentclass{article}
            \usepackage{jsonresume}
            \begin{document}
            \resumefromfile{resume.json}
            \renderresume
            \end{document}
            ```
            Compile with: `lualatex --shell-escape yourfile.tex`
          draft: false
          prerelease: false

      - name: Submit to CTAN
        uses: paolobrasolin/ctan-submit-action@v1
        continue-on-error: true
        with:
          action: upload
          file_path: dist/jsonresume-ctan.zip
          fields: |
            update: "true"
            pkg: jsonresume
            version: ${{ steps.get_version.outputs.VERSION }}
            announcement: ${{ steps.changelog.outputs.CHANGELOG }}
            uploader: ${{ secrets.CTAN_UPLOADER_NAME }}
            email: ${{ secrets.CTAN_EMAIL }}
            bugtracker: ${{ github.server_url }}/${{ github.repository }}/issues
