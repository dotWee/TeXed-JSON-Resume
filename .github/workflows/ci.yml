name: CI

on:
  push:

  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install TeX Live
        uses: zauguin/install-texlive@v4
        with:
          packages: >
            scheme-basic
            luatex
            luaotfload
            fontspec
            enumitem
            l3kernel
            l3packages
            hyperref
            geometry
            lm
            etoolbox
            iftex
            kvsetkeys
            kvdefinekeys
            kvoptions
            ltxcmds
            infwarerr
            intcalc
            bigintcalc
            bitset
            atbegshi
            atveryend
            rerunfilecheck
            uniquecounter
            refcount
            hycolor
            letltxmacro
            auxhook
            pdfescape
            stringenc
            pdftexcmds
            url

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Run tests
        run: |
          cd tests
          chmod +x run-tests.sh
          ./run-tests.sh --skip-network

      - name: Run network tests
        run: |
          cd tests
          ./run-tests.sh
        continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install TeX Live
        uses: zauguin/install-texlive@v4
        with:
          packages: >
            scheme-basic
            luatex
            luaotfload
            fontspec
            enumitem
            l3kernel
            l3packages
            hyperref
            geometry
            lm
            etoolbox
            iftex
            kvsetkeys
            kvdefinekeys
            kvoptions
            ltxcmds
            infwarerr
            intcalc
            bigintcalc
            bitset
            atbegshi
            atveryend
            rerunfilecheck
            uniquecounter
            refcount
            hycolor
            letltxmacro
            auxhook
            pdfescape
            stringenc
            pdftexcmds
            url

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Build example PDF
        run: |
          cd example
          lualatex --shell-escape --interaction=nonstopmode jsonresume-example.tex || true
          lualatex --shell-escape --interaction=nonstopmode jsonresume-example.tex || true

      - name: Upload example PDF
        uses: actions/upload-artifact@v6
        with:
          name: example-pdf
          path: example/jsonresume-example.pdf

  changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Print upcoming changelog
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "## Upcoming changelog"
          if [ -n "$LATEST_TAG" ]; then
            echo "Changes since ${LATEST_TAG}:"
          else
            echo "Changes (no previous tag found):"
          fi
          echo ""
          ./scripts/git-changelog.sh
